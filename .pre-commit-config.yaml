# See https://pre-commit.com for more information
# TODO: Add pre-commits from https://github.com/pre-commit/pygrep-hooks.
# TODO: Add pre-commits from
# https://github.com/orgs/pre-commit/repositories?language=&q=%22mirrors-%22+archived%3AFalse&sort=.
# TODO: Add pre-commits from https://pre-commit.com/hooks.html.
# TODO: Add a pre-commit for bash script.
# TODO: Add a pre-commit for Makefile.
# TODO: Enable more of the commented-out hooks below. These were only commented
# out because they are hard to satisfy at the time they were introduced, but
# the plan is to enable them in the long run.

exclude: ^archive/

repos:
  # Language-agnostic.
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      # - id: check-added-large-files
      - id: check-ast
      - id: check-builtin-literals
      - id: check-case-conflict
      - id: check-docstring-first
      - id: check-executables-have-shebangs
      # - id: check-illegal-windows-names
      # - id: check-json
      - id: check-merge-conflict
      # - id: check-shebang-scripts-are-executable
      - id: check-symlinks
      - id: check-vcs-permalinks
      # - id: check-xml
      - id: check-yaml
      - id: debug-statements
      - id: destroyed-symlinks
      # - id: detect-aws-credentials
      - id: detect-private-key
      # - id: double-quote-string-fixer
      # - id: file-contents-sorter
      # - id: end-of-file-fixer
      - id: fix-byte-order-marker
      # - id: forbid-submodules
      # - id: mixed-line-ending
      - id: name-tests-test
      # - id: no-commit-to-branch
      # - id: pretty-format-json
      - id: requirements-txt-fixer
      - id: sort-simple-yaml
      # - id: trailing-whitespace

  - repo: https://github.com/mxr/sync-pre-commit-deps
    rev: v0.0.1
    hooks:
    - id: sync-pre-commit-deps

  # Python.
  - repo: https://github.com/psf/black-pre-commit-mirror
    rev: 24.2.0
    hooks:
      - id: black
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: isort (python)

  # Markdown.
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.40.0
    hooks:
      - id: markdownlint-fix
        args: [--disable, MD033, MD036]

  # Local scripts.
  - repo: local
    hooks:
      - id: marcion-validate
        name: marcion-validate
        entry: dictionary/marcion.sourceforge.net/img_validate.sh
        language: script
        # N.B. It's not currently possible to limit this pre-commit to a
        # specific directory or set of files because it needs to be run on
        # deletions as well, which is not straightforward to support in
        # pre-commit.
        pass_filenames: false

      - id: doctoc
        name: doctoc
        entry: doctoc
        language: system
        types: [markdown]

      - id: tidy-html
        name: tidy-html
        entry: tidy -indent -modify -quiet --tidy-mark no -wrap 80
        language: system
        files: '.*\.html'
        # TODO: Fix and reinclude the file below. While it's unused in our
        # pipelines, it's useful for manual word lookups.
        # We currently encounter the following errors while processing it:
        #   Warning: <cit> end of file while parsing attributes
        #   Warning: <ref> end of file while parsing attributes
        #   Warning: <table> attribute "cellpadding" not allowed for HTML5
        #   Warning: <table> attribute "cellspacing" not allowed for HTML5
        #   Warning: <table> lacks "summary" attribute
        exclude: dictionary/marcion\.sourceforge\.net/data/marcion-raw/search_results\.html

      - id: tidy-xml
        name: tidy-xml
        entry: tidy -indent -modify -quiet --tidy-mark no -wrap 80 -xml
        language: system
        files: '.*\.(xml|xhtml)'

      - id: stats
        name: stats
        entry: bash -c 'if [[ $(find stats.tsv -mtime +1) ]]; then make stats; fi'
        language: system
        pass_filenames: false
        always_run: true

      # N.B. This pre-commit rule forces us to host at least placeholder unit
      # tests in each Python directory, otherwise test discovery will fail and
      # the pre-commit will fail.
      # This is OK. Placeholder tests are also a reminder for us to write them.
      - id: python-unittest
        name: python-unittest
        entry: bash -c 'for x in $(dirname "$@" | uniq); do python -m unittest discover "$x"; done' --
        language: system
        types: [python]
        verbose: true
